# Day 13 Notes: Securing Apache with iptables

## üõ°Ô∏è Security Objective

The primary goal was to harden the application servers (`stapp01`, `stapp02`, `stapp03`) by implementing a firewall. The Apache service, running on a custom port (`6400`), was exposed to the public internet. The new security policy dictates that this port should only be accessible from a trusted source, the Load Balancer (LBR), while blocking all other non-essential incoming traffic.

## üî• Understanding iptables: The Linux Firewall

`iptables` is a user-space utility that allows a system administrator to configure the IP packet filter rules of the Linux kernel firewall, implemented as different Netfilter modules.

### Key Concepts:

- **Tables**: Contain chains. The most common is the `filter` table, used for packet filtering.
- **Chains**: A list of rules that a packet is checked against. The main built-in chains are:
  - `INPUT`: For packets destined for the local server.
  - `OUTPUT`: For packets generated by the local server.
  - `FORWARD`: For packets being routed through the server.
- **Rules**: A condition and a target. If the packet matches the condition, it's sent to the target.
- **Targets**: What to do with a matching packet. Common targets are:
  - `ACCEPT`: Allow the packet.
  - `DROP`: Silently discard the packet.
  - `REJECT`: Discard the packet and send an error back.
- **Policy**: The default target for a chain. If a packet doesn't match any rule in the chain, the policy is applied. A `DROP` policy is a security best practice.

## üõ†Ô∏è Solution Breakdown

A shell script, `secure_apache.sh`, was created to automate the firewall setup on all app servers.

### Step 1: Install `iptables-services`

While `iptables` is often present, the `iptables-services` package is needed to easily manage rule persistence across reboots using `systemctl` and `service iptables save`.

```bash
sudo yum install -y iptables-services
```

### Step 2: Establish a Secure Baseline

Before adding specific `ALLOW` rules, a secure foundation was laid:

1.  **Flush Existing Rules**: `sudo iptables -F` ensures a clean slate.
2.  **Set Default Policy to DROP**:
    ```bash
    sudo iptables -P INPUT DROP
    ```
    This is the core of the security model: "deny by default." Any traffic not explicitly allowed is blocked.

### Step 3: Allow Essential Traffic

A server with a `DROP` policy needs explicit rules to function correctly:

1.  **Loopback Traffic**: Required for internal communication.
    ```bash
    sudo iptables -A INPUT -i lo -j ACCEPT
    ```
2.  **Established Connections**: This is crucial. It allows the server to receive return packets for connections it initiated. Without this, things like `yum update` or `curl` would fail.
    ```bash
    sudo iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
    ```
3.  **SSH Access**: To prevent being locked out of the server.
    ```bash
    sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```

### Step 4: Allow Application Traffic from LBR

This is the primary business requirement. A rule was added to the `INPUT` chain to accept TCP traffic on port `6400`, but only if it originates from the Load Balancer's IP address.

```bash
# Assuming LBR IP is 172.16.238.14
sudo iptables -A INPUT -p tcp -s 172.16.238.14 --dport 6400 -j ACCEPT
```

Using `-s <ip_address>` (source) is key to restricting access.

### Step 5: Persist the Rules

`iptables` rules are volatile and are lost on reboot. The `iptables-services` package provides a simple way to save them.

```bash
sudo service iptables save
sudo systemctl enable iptables
```

This saves the current rules to `/etc/sysconfig/iptables` and ensures the service loads them at boot.

## üí° Lessons Learned & Best Practices

- **Deny by Default**: Always set the `INPUT` chain's default policy to `DROP`. It's much safer than an `ACCEPT` policy where you have to remember to block everything dangerous.
- **Don't Lock Yourself Out**: Always add a rule for SSH _before_ setting the default policy to `DROP`.
- **Stateful is Smart**: The `RELATED,ESTABLISHED` rule is fundamental for any stateful firewall.
- **Be Specific**: Use source (`-s`) and destination (`-d`) flags whenever possible to make rules as restrictive as necessary.
- **Automate for Consistency**: Using a script ensures the same firewall rules are applied consistently across all servers, reducing human error.
